[tox]
envlist = py311, e2e
isolated_build = True

[testenv]
deps =
    pytest>=7.0.0
    pytest-asyncio>=0.21.0
    requests>=2.28.0
    psutil>=5.9.0
    google-cloud-firestore>=2.21.0
    fastapi>=0.116.1
    uvicorn>=0.35.0
    openai>=1.97.0
    twilio>=9.6.5
    python-multipart>=0.0.20
    fasttext>=0.9.2
    aiohttp>=3.10.11
    PyYAML>=6.0.1
commands =
    pytest {posargs:sofia_lite/tests/}

[testenv:e2e]
deps =
    {[testenv]deps}
    google-cloud-firestore-emulator>=0.0.1
commands_pre =
    # Start Firestore emulator
    gcloud emulators firestore start --host-port=localhost:8080 --project=test-project &
    # Wait for emulator to start
    sleep 5
    # Set environment variables
    setenv =
        FIRESTORE_EMULATOR_HOST = localhost:8080
        GOOGLE_CLOUD_PROJECT = test-project
        GOOGLE_APPLICATION_CREDENTIALS = /dev/null
        OPENAI_API_KEY = test-key
        ELEVENLABS_API_KEY = test-key
        TWILIO_ACCOUNT_SID = test-sid
        TWILIO_AUTH_TOKEN = test-token
commands =
    # Run E2E tests
    python scripts/run_e2e.py {posargs:}
commands_post =
    # Stop emulator
    pkill -f "gcloud emulators firestore"
