# ===== SOFIA AI - PRODUCTION ALERT RULES =====
groups:
  - name: sofia-ai-alerts
    rules:
      # ===== APPLICATION HEALTH =====
      - alert: SofiaAI_Down
        expr: up{job="sofia-ai"} == 0
        for: 1m
        labels:
          severity: critical
          service: sofia-ai
        annotations:
          summary: "Sofia AI is down"
          description: "Sofia AI application has been down for more than 1 minute"

      - alert: SofiaAI_HealthCheck_Failed
        expr: up{job="sofia-health"} == 0
        for: 2m
        labels:
          severity: warning
          service: sofia-ai
        annotations:
          summary: "Sofia AI health check failing"
          description: "Sofia AI health endpoint is not responding for 2 minutes"

      # ===== RESPONSE TIME =====
      - alert: SofiaAI_High_Response_Time
        expr: rate(sofia_request_duration_seconds_sum[5m]) / rate(sofia_request_duration_seconds_count[5m]) > 3
        for: 5m
        labels:
          severity: warning
          service: sofia-ai
        annotations:
          summary: "High response time detected"
          description: "Average response time is above 3 seconds for 5 minutes"

      # ===== ERROR RATES =====
      - alert: SofiaAI_High_Error_Rate
        expr: rate(sofia_errors_total[5m]) > 0.1
        for: 3m
        labels:
          severity: critical
          service: sofia-ai
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 10% for 3 minutes"

      # ===== MEMORY USAGE =====
      - alert: SofiaAI_High_Memory_Usage
        expr: container_memory_usage_bytes{container_label_com_docker_compose_service="sofia-ai"} / container_spec_memory_limit_bytes{container_label_com_docker_compose_service="sofia-ai"} > 0.9
        for: 5m
        labels:
          severity: warning
          service: sofia-ai
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 90% for 5 minutes"

      # ===== CPU USAGE =====
      - alert: SofiaAI_High_CPU_Usage
        expr: rate(container_cpu_usage_seconds_total{container_label_com_docker_compose_service="sofia-ai"}[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          service: sofia-ai
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is above 80% for 10 minutes"

      # ===== WEBHOOK MONITORING =====
      - alert: SofiaAI_Webhook_Failures
        expr: rate(twilio_webhook_failures_total[5m]) > 0.05
        for: 3m
        labels:
          severity: warning
          service: twilio-webhooks
        annotations:
          summary: "Twilio webhook failures"
          description: "Twilio webhook failure rate is above 5% for 3 minutes"

      # ===== DATABASE CONNECTION =====
      - alert: SofiaAI_Database_Connection_Issues
        expr: rate(firestore_connection_errors_total[5m]) > 0
        for: 2m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection issues"
          description: "Firestore connection errors detected for 2 minutes"

      # ===== SYSTEM RESOURCES =====
      - alert: High_Disk_Usage
        expr: (node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}) / node_filesystem_size_bytes{fstype!="tmpfs"} > 0.85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High disk usage"
          description: "Disk usage is above 85% for 5 minutes"

      - alert: High_System_Load
        expr: node_load1 > 4
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High system load"
          description: "System load average is high for 5 minutes" 