[tox]
envlist = py311, e2e, bulk, lint

[testenv]
deps =
    pytest==7.4.0
    pytest-asyncio==0.21.1
    pytest-mock==3.11.1
    requests>=2.28.0
    psutil>=5.9.0
    google-cloud-firestore==2.18.0
    fastapi==0.111.0
    uvicorn==0.30.0
    openai==1.57.0
    twilio==9.0.0
    python-multipart>=0.0.20
    fasttext>=0.9.2
    aiohttp>=3.10.11
    PyYAML>=6.0.1
commands =
    pytest {posargs:sofia_lite/tests/}

[testenv:bulk]
deps =
    {[testenv]deps}
    httpx==0.27.0
    slowapi==0.1.9
    tinydb==4.8.0
    boto3==1.34.0
    pydantic==2.10.0
    python-dotenv==1.0.0
commands =
    pytest {posargs:tests_bulk/} -m bulk

[testenv:e2e]
deps =
    {[testenv]deps}
    google-cloud-firestore-emulator>=0.0.1
commands_pre =
    # Start Firestore emulator
    gcloud emulators firestore start --host-port=localhost:8080 --project=test-project &
    # Wait for emulator to start
    sleep 5
    # Set environment variables
    setenv =
        FIRESTORE_EMULATOR_HOST = localhost:8080
        GOOGLE_CLOUD_PROJECT = test-project
        GOOGLE_APPLICATION_CREDENTIALS = /dev/null
        OPENAI_API_KEY = test-key
        ELEVENLABS_API_KEY = test-key
        TWILIO_ACCOUNT_SID = test-sid
        TWILIO_AUTH_TOKEN = test-token
commands =
    # Run E2E tests
    python scripts/run_e2e.py {posargs:}
commands_post =
    # Stop emulator
    pkill -f "gcloud emulators firestore"

[testenv:lint]
deps =
    black>=22.0.0
    isort>=5.10.0
    flake8>=4.0.0
commands =
    black --check sofia_lite/ sofia_bulk_api/
    isort --check-only sofia_lite/ sofia_bulk_api/
    flake8 sofia_lite/ sofia_bulk_api/

[testenv:format]
deps =
    black>=22.0.0
    isort>=5.10.0
commands =
    black sofia_lite/ sofia_bulk_api/
    isort sofia_lite/ sofia_bulk_api/

[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude = .git,__pycache__,build,dist,*.egg-info

[isort]
profile = black
multi_line_output = 3
line_length = 88 